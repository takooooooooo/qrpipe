<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Code File Transmitter</title>
<style>
body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 2rem; background-color: #f0f0f0; }
#qrcodeContainer { margin: 1rem 0; width: 300px; height: 300px; border: 1px solid #ccc; background-color: #fff; display: flex; justify-content: center; align-items: center; }
#qrcodeContainer img { max-width: 100%; max-height: 100%; }
.controls, .status { margin: 0.5rem 0; }
</style>
</head>
<body>
<h1>QRコード ファイル送信</h1>

<div class="controls">
    <input type="file" id="fileInput">
</div>

<div id="qrcodeContainer">
    <p>ここにQRコードが表示されます</p>
</div>

<div class="controls">
    <button id="startButton" disabled>送信開始</button>
    <button id="stopButton" disabled>送信停止</button>
</div>

<div class="status">
    <p id="statusText">ファイルを選択してください</p>
    <p id="bitrateText">転送速度: - kbps</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
<script src="common.js"></script>
<script>
// CRC32 計算
const crcTable = (() => { let c; const table = []; for (let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1));}table[n]=c;} return table; })();
const crc32 = (str) => { let crc=0^(-1); for(let i=0;i<str.length;i++){crc=(crc>>>8)^crcTable[(crc^str.charCodeAt(i))&0xFF];} return (crc^(-1))>>>0; };

// ArrayBuffer → Base64 安全変換
function arrayBufferToBase64(buffer){
    const bytes = new Uint8Array(buffer);
    let binary = '';
    const chunkSize = 0x8000; // 32KBずつ処理
    for (let i=0; i<bytes.length; i+=chunkSize){
        const sub = bytes.subarray(i, i+chunkSize);
        binary += String.fromCharCode.apply(null, sub);
    }
    return btoa(binary);
}

document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const qrcodeContainer = document.getElementById('qrcodeContainer');
    const statusText = document.getElementById('statusText');
    const bitrateText = document.getElementById('bitrateText');

    let base64Data = "", chunks=[], qrCodeCache=[], currentIndex=0, transmissionIntervalId=null, isTransmitting=false;
    let selectedFile=null, startTime=0, worker=null;

    fileInput.addEventListener('change', () => {
        selectedFile = fileInput.files[0];
        if(selectedFile){ 
            startButton.disabled=false; 
            statusText.textContent=`ファイル選択中: ${selectedFile.name} (${(selectedFile.size/1024).toFixed(2)} KB)`;
            console.log(`File selected: ${selectedFile.name}, size=${selectedFile.size}`);
        }
    });

    startButton.addEventListener('click', () => { 
        if(!selectedFile){ alert('ファイル選択してください'); return;} 
        startTransmission(); 
    });

    stopButton.addEventListener('click', stopTransmission);

    function startTransmission(){
        startButton.disabled=true; stopButton.disabled=false; statusText.textContent='ファイルの読み込み中...';
        const reader = new FileReader();
        reader.onload = (e) => {
            const fileBuffer = e.target.result;
            base64Data = arrayBufferToBase64(fileBuffer); // 安全変換
            console.log(`base64Data length=${base64Data.length}`); // デバッグ
            createChunks(base64Data);
            generateAllQRCodesViaWorker();
        };
        reader.readAsArrayBuffer(selectedFile);
    }

    function stopTransmission(){
        isTransmitting=false;
        if(transmissionIntervalId) clearInterval(transmissionIntervalId);
        if(worker){ worker.terminate(); worker=null; }
        startButton.disabled=false; stopButton.disabled=true;
        statusText.textContent='送信停止'; 
        bitrateText.textContent='転送速度: - kbps';
        console.log("Transmission stopped.");
    }

    function createChunks(base64Str){
        chunks = [];
        const totalChunks = Math.ceil(base64Str.length / PROTOCOL_CONFIG.PAYLOAD_SIZE);
        console.log(`Creating ${totalChunks} chunks, each max ${PROTOCOL_CONFIG.PAYLOAD_SIZE} chars`);
        for(let i=0; i<totalChunks; i++){
            const part = base64Str.substring(i*PROTOCOL_CONFIG.PAYLOAD_SIZE, (i+1)*PROTOCOL_CONFIG.PAYLOAD_SIZE);
            if(part.length === 0) console.warn(`Warning: chunk ${i} is empty`);
            const checksum = crc32(part);
            chunks.push(JSON.stringify({i:i,t:totalChunks,d:part,c:checksum,n:selectedFile.name,m:selectedFile.type}));
        }
        console.log(`Chunks created: ${chunks.length}`);
    }

    function generateAllQRCodesViaWorker(){
        statusText.textContent='QRコード生成Workerを準備中...';
        worker = new Worker('transmitter_worker.js');
        worker.onmessage = (event) => {
            const {type, progress, total, cache, message} = event.data;
            if(type==='progress'){ 
                statusText.textContent=`QRコード生成中... (${progress}/${total})`; 
            }
            else if(type==='complete'){ 
                qrCodeCache = cache; 
                statusText.textContent='QRコード生成完了。送信開始'; 
                isTransmitting = true; 
                currentIndex = 0; 
                startTime = Date.now(); 
                startQrDisplay(); 
                worker.terminate(); 
                worker = null; 
                console.log("All QR codes generated, starting transmission.");
            }
            else if(type==='error'){ 
                console.error(message); 
                stopTransmission(); 
                statusText.textContent=`エラー: QR生成失敗`; 
            }
        };
        worker.postMessage({chunks:chunks, qrConfig:QR_CONFIG});
        console.log("Worker message posted for QR generation");
    }

    function startQrDisplay(){
        if(transmissionIntervalId) clearInterval(transmissionIntervalId);
        transmissionIntervalId = setInterval(()=>{
            if(!isTransmitting) return;
            if(currentIndex>=chunks.length){
                const elapsed=(Date.now()-startTime)/1000;
                const totalBits=base64Data.length*6;
                bitrateText.textContent=`転送速度: ${(totalBits/elapsed/1000).toFixed(2)} kbps`;
                currentIndex=0; startTime=Date.now();
            }
            qrcodeContainer.innerHTML = qrCodeCache[currentIndex];
            statusText.textContent = `${currentIndex+1}/${chunks.length} 送信中...`;
            console.log(`Displaying QR ${currentIndex+1}/${chunks.length}, data length=${chunks[currentIndex].length}`);
            currentIndex++;
        }, PROTOCOL_CONFIG.TRANSMISSION_INTERVAL);
    }

});
</script>
</body>
</html>
