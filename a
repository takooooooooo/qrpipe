<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code File Receiver</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 2rem; background-color: #f0f0f0; }
        #video { width: 300px; height: 300px; border: 1px solid #ccc; background-color: #000; }
        .status { margin: 1rem 0; width: 300px; }
        #progressBar { width: 100%; }
        #downloadContainer a { display: block; padding: 10px; background-color: #28a745; color: white; text-align: center; text-decoration: none; border-radius: 5px; margin-top: 1rem; }
        #logText { width: 300px; height: 150px; font-size: 0.8em; }
    </style>
</head>
<body>
    <h1>QRコード ファイル受信</h1>

    <video id="video" autoplay playsinline></video>

    <p style="margin-top: 1rem; margin-bottom: 0.2rem; font-weight: bold;">↓ 解析している瞬間の画像 ↓</p>
    <canvas id="previewCanvas" style="max-width: 300px; border: 2px solid blue;"></canvas>
    
    <div class="status">
        <p id="statusText">カメラをQRコードに向けてください</p>
        <progress id="progressBar" value="0" max="100"></progress>
        <p id="bitrateText">転送速度: - kbps</p>
    </div>

    <div id="downloadContainer"></div>

    <textarea id="logText" readonly placeholder="受信ログ..."></textarea>

    <div class="controls" style="margin-top: 0.5rem;">
        <button id="copyLogButton">ログをクリップボードにコピー</button>
    </div>

    <script src="common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');
            const statusText = document.getElementById('statusText');
            const progressBar = document.getElementById('progressBar');
            const downloadContainer = document.getElementById('downloadContainer');
            const logText = document.getElementById('logText');
            const bitrateText = document.getElementById('bitrateText');
            const copyLogButton = document.getElementById('copyLogButton');

            // --- CRC32計算 ---
            const crc32 = (() => {
                const crcTable = (() => {
                    let c;
                    const table = [];
                    for (let n = 0; n < 256; n++) {
                        c = n;
                        for (let k = 0; k < 8; k++) {
                            c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
                        }
                        table[n] = c;
                    }
                    return table;
                })();
                return (str) => {
                    let crc = 0 ^ (-1);
                    for (let i = 0; i < str.length; i++) {
                        crc = (crc >>> 8) ^ crcTable[(crc ^ str.charCodeAt(i)) & 0xFF];
                    }
                    return (crc ^ (-1)) >>> 0;
                };
            })();

            // --- Base64 → Uint8Array ---
            function base64ToUint8Array(base64) {
                const binaryString = atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes;
            }

            // --- ログ出力 ---
            function log(message) {
                const time = new Date().toLocaleTimeString();
                logText.value += `[${time}] ${message}\n`;
                logText.scrollTop = logText.scrollHeight;
                console.log(`[DEBUG] ${message}`);
            }

            copyLogButton.addEventListener('click', () => {
                if (!logText.value) return;
                navigator.clipboard.writeText(logText.value).then(() => {
                    const originalText = copyLogButton.textContent;
                    copyLogButton.textContent = 'コピーしました！';
                    copyLogButton.disabled = true;
                    setTimeout(() => {
                        copyLogButton.textContent = originalText;
                        copyLogButton.disabled = false;
                    }, 2000);
                });
            });

            // --- 受信状態管理 ---
            let receivedChunks = [];
            let totalChunks = 0;
            let receivedCount = 0;
            let stream = null;
            let animationFrameId = null;
            
            let workerPool = [];
            let isWorkerBusy = [];
            const workerCount = 16;
            let startTime = 0;
            let receivedFileName = 'downloaded_file'; // デフォルトファイル名

            function startScan() {
                log(`Worker数: ${workerCount} を初期化中...`);
                workerPool.forEach(worker => worker.terminate());
                workerPool = [];
                isWorkerBusy = new Array(workerCount).fill(false);

                [...Array(workerCount).keys()].forEach(i => {
                    const worker = new Worker('qr_worker.js');
                    worker.onmessage = (event) => {
                        const { found, data, duration } = event.data;
                        isWorkerBusy[i] = false;
                        log(`Worker ${i} finished. message: ${JSON.stringify(event.data)}`);
                        if (found) {
                            handleQrCode(data);
                        }
                    };
                    workerPool.push(worker);
                });

                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } })
                    .then(mediaStream => {
                        stream = mediaStream;
                        video.srcObject = stream;
                        video.onloadedmetadata = () => {
                            video.play();
                            const canvas = document.getElementById('previewCanvas');
                            const context = canvas.getContext('2d', { willReadFrequently: true });
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            animationFrameId = requestAnimationFrame(() => tick(context, canvas));
                        };
                    })
                    .catch(err => {
                        statusText.textContent = "カメラにアクセスできませんでした。";
                        log(`カメラエラー: ${err.message}`);
                    });
            }

            function tick(context, canvas) {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    const freeWorkerIndex = isWorkerBusy.findIndex(busy => !busy);
                    if (freeWorkerIndex !== -1) {
                        isWorkerBusy[freeWorkerIndex] = true;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                        // コピーしてWorkerに送信（Transferではなくコピー）
                        const copiedImageData = new ImageData(
                            new Uint8ClampedArray(imageData.data),
                            imageData.width,
                            imageData.height
                        );
                        log(`Sending ImageData to worker ${freeWorkerIndex}. width=${copiedImageData.width}, height=${copiedImageData.height}`);
                        workerPool[freeWorkerIndex].postMessage(imageData, [imageData.data.buffer]);

                    }
                }
                if (receivedCount < totalChunks || totalChunks === 0) {
                   animationFrameId = requestAnimationFrame(() => tick(context, canvas));
                }
            }

            function handleQrCode(data) {
                try {
                    log(`handleQrCode received data length=${data.length}`);
                    log(`handleQrCode raw data=${data.substring(0,100)}...`);
                    const chunk = JSON.parse(data);
                    if (typeof chunk.i !== 'number' || typeof chunk.t !== 'number' || typeof chunk.d !== 'string' || typeof chunk.c !== 'number') {
                        return;
                    }
                    if (crc32(chunk.d) !== chunk.c) {
                        log(`チャンク ${chunk.i} のCRCエラー → 破棄`);
                        return;
                    }
                    if (totalChunks === 0) {
                        startTime = Date.now();
                        totalChunks = chunk.t;
                        receivedChunks = new Array(totalChunks);
                        progressBar.max = totalChunks;
                        log(`受信開始: 総チャンク数 ${totalChunks}`);
                    }

                    // ファイル名がまだ設定されていなければ、このチャンクから取得を試みる
                    if (receivedFileName === 'downloaded_file' && typeof chunk.n === 'string') {
                        receivedFileName = chunk.n;
                        log(`ファイル名取得: ${receivedFileName}`);
                    }
                    if (chunk.t !== totalChunks) {
                        log(`別ファイルを検出 → リセット`);
                        reset();
                        return;
                    }
                    if (receivedChunks[chunk.i] === undefined) {
                        receivedChunks[chunk.i] = chunk.d;
                        receivedCount++;
                        progressBar.value = receivedCount;
                        statusText.textContent = `${receivedCount}/${totalChunks} 受信中...`;
                        if (receivedCount === totalChunks) {
                            completeReception();
                        }
                    }
                } catch (e) {
                    log(`handleQrCode error: JSON Parse error: ${e.message}`);
                }
            }

            function reset() {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (stream) stream.getTracks().forEach(track => track.stop());
                workerPool.forEach(worker => worker.terminate());
                workerPool = [];
                receivedChunks = [];
                totalChunks = 0;
                receivedCount = 0;
                startTime = 0;
                progressBar.value = 0;
                statusText.textContent = 'カメラをQRコードに向けてください';
                downloadContainer.innerHTML = '';
                bitrateText.textContent = '転送速度: - kbps';
                startScan();
            }

            function completeReception() {
                const endTime = Date.now();
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (stream) stream.getTracks().forEach(track => track.stop());
                workerPool.forEach(worker => worker.terminate());

                setTimeout(() => {
                    try {
                        const fullBase64 = receivedChunks.join('');
                        const fileData = base64ToUint8Array(fullBase64);
                        const blob = new Blob([fileData]); // ★送信側に合わせてMIMEを設定可能
                        const url = URL.createObjectURL(blob);

                        const elapsedTime = (endTime - startTime) / 1000;
                        const kbps = (fileData.length * 8 / elapsedTime) / 1000;
                        bitrateText.textContent = `転送速度: ${kbps.toFixed(2)} kbps`;

                        const a = document.createElement('a');
                        a.href = url;
                        a.download = receivedFileName; // 受信したファイル名を設定
                        a.textContent = 'ファイルをダウンロード';
                        downloadContainer.innerHTML = '';
                        downloadContainer.appendChild(a);

                        statusText.textContent = '受信完了！ダウンロード可能';
                        log('全チャンク受信→ファイル生成完了');
                    } catch (e) {
                        log(`復元エラー: ${e.message}`);
                        statusText.textContent = 'ファイルの復元に失敗しました';
                    }
                }, 50);
            }

            // --- 初期化 ---
            startScan();
        });
    </script>
</body>
</html>
